apiVersion: apps/v1
kind: Deployment
metadata:
  name: penpot-backend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: penpot-backend
  template:
    metadata:
      labels:
        app: penpot-backend
    spec:
      nodeSelector:
        kubernetes.io/hostname: srv1016685
      initContainers:
        - name: fix-permissions
          image: busybox:1.36
          command: ["sh", "-c", "chown -R 1001:1001 /opt/data/objects"]
          volumeMounts:
            - name: penpot-assets
              mountPath: /opt/data/objects
      containers:
        - name: penpot-backend
          image: penpotapp/backend:2.11.1
          ports:
            - containerPort: 6060
          env:
            - name: PENPOT_DATABASE_HOST
              value: "postgres.kq.svc.cluster.local"
            - name: PENPOT_DATABASE_PORT
              value: "5432"
            - name: PENPOT_DATABASE_DB
              value: "penpot"
            - name: PENPOT_DATABASE_USERNAME
              value: "penpot"
            - name: PENPOT_DATABASE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: kq-penpot-secrets
                  key: PENPOT_DATABASE_PASSWORD
            - name: PENPOT_REDIS_URI
              value: "redis://penpot-redis.kq.svc.cluster.local:6379/0"
            - name: PENPOT_PUBLIC_URI
              value: "https://design.bitspace.org.in"
            - name: PENPOT_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: kq-penpot-secrets
                  key: PENPOT_SECRET_KEY
            - name: PENPOT_WEBSOCKETS_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: kq-penpot-secrets
                  key: PENPOT_WEBSOCKETS_SECRET_KEY
            - name: PENPOT_FLAGS
              value: "email-verification registration login-with-password enable-log-emails enable-smtp"
            - name: PENPOT_TELEMETRY_ENABLED
              value: "false"
            - name: PENPOT_SMTP_ENABLED
              value: "true"
            - name: PENPOT_SMTP_HOST
              value: "mail.bitspace.org.in"
            - name: PENPOT_SMTP_PORT
              value: "587"
            - name: PENPOT_SMTP_DEFAULT_FROM
              value: "no-reply@bitspace.org.in"
            - name: PENPOT_SMTP_DEFAULT_REPLY_TO
              value: "support@bitspace.org.in"
            - name: PENPOT_SMTP_USERNAME
              value: "no-reply@bitspace.org.in"
            - name: PENPOT_SMTP_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: kq-penpot-secrets
                  key: PENPOT_SMTP_PASSWORD
            - name: PENPOT_SMTP_TLS
              value: "true"
            - name: PENPOT_SMTP_SSL
              value: "false"
            - name: PENPOT_OBJECTS_STORAGE_BACKEND
              value: "fs"
            - name: PENPOT_OBJECTS_STORAGE_FS_DIRECTORY
              value: "/opt/data/objects"
          volumeMounts:
            - name: penpot-assets
              mountPath: /opt/data/objects
      volumes:
        - name: penpot-assets
          persistentVolumeClaim:
            claimName: penpot-assets-pvc
---
apiVersion: v1
kind: Service
metadata:
  name: penpot-backend
spec:
  selector:
    app: penpot-backend
  ports:
    - port: 6060
      targetPort: 6060
      protocol: TCP
